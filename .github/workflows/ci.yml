name: CI - Nix Configuration Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  check-nix-config:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v24
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Cachix (optional, speeds up builds)
      uses: cachix/cachix-action@v12
      with:
        name: nix-community
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      continue-on-error: true
    
    - name: Check flake structure
      run: nix flake check
    
    - name: Build home-manager configuration
      run: |
        nix build .#homeConfigurations.cake.activationPackage \
          --show-trace \
          --print-build-logs
    
    - name: Check for evaluation errors
      run: |
        nix eval .#homeConfigurations.cake.config.home.username
        nix eval .#homeConfigurations.cake.config.home.stateVersion
    
    - name: Validate module imports
      run: |
        echo "Checking if all modules can be imported..."
        nix eval .#homeConfigurations.cake.config.home.packages --apply 'builtins.length' > /dev/null
        echo "âœ… All modules imported successfully"
    
    - name: Summary
      if: success()
      run: |
        echo "âœ¨ Configuration check passed!"
        echo "ðŸ“¦ Home Manager configuration builds successfully"
        echo "ðŸŽ‰ Ready to deploy"
